<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¬”è¯•æŒ‘æˆ˜èµ›</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* ==================== æ ·å¼åŒº ==================== */
        body { font-family: 'Comic Sans MS', 'Chalkboard SE', sans-serif; background-color: #fff3e0; margin: 0; padding: 20px; color: #333; }
        
        .home-link { position: fixed; top: 15px; left: 15px; z-index: 1000; background-color: #607d8b; color: white; text-decoration: none; padding: 8px 15px; border-radius: 20px; font-size: 14px; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .home-link:hover { background-color: #546e7a; }

        .container { max-width: 800px; margin: 0 auto; padding-top: 40px; }
        
        .welcome-card { background: white; border-radius: 20px; padding: 30px; margin: 0 auto; max-width: 500px; box-shadow: 0 8px 20px rgba(0,0,0,0.08); border: 4px solid #fff; text-align: center; }
        .hero-icon { font-size: 60px; margin-bottom: 10px; animation: bounce 2s infinite; }
        .main-title { color: #fb8c00; margin: 0 0 20px 0; }
        
        .selector-group { text-align: left; margin-bottom: 20px; }
        .selector-label { font-weight: bold; color: #555; display: block; margin-bottom: 8px; }
        select { width: 100%; padding: 12px; font-size: 16px; border: 2px solid #e0e0e0; border-radius: 10px; background: #fafafa; outline: none; }
        select:focus { border-color: #fb8c00; background: #fff; }
        
        #startButton { background: #4caf50; color: white; border: none; padding: 15px 40px; border-radius: 30px; font-size: 18px; font-weight: bold; cursor: pointer; width: 100%; box-shadow: 0 4px 10px rgba(76, 175, 80, 0.3); transition: transform 0.1s; }
        #startButton:active { transform: scale(0.95); }
        #startButton:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; }

        #fixedHeader { display: none; justify-content: space-between; align-items: center; position: sticky; top: 0; background: rgba(255,255,255,0.95); padding: 10px 20px; z-index: 99; border-radius: 0 0 15px 15px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .student-badge { font-weight: bold; color: #333; font-size: 16px; }
        #timerDisplay { font-family: monospace; font-weight: bold; color: #e65100; background: #ffe0b2; padding: 5px 10px; border-radius: 15px; }

        .question-page { background: white; border-radius: 16px; padding: 20px; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-left: 6px solid #fb8c00; }
        .answer-option { padding: 12px; border: 2px solid #eee; border-radius: 10px; cursor: pointer; background: white; transition: all 0.2s; }
        .answer-option:hover { background-color: #fff3e0; }
        .selected-option { border-color: #fb8c00; background-color: #fff8e1; }
        
        .drag-target { border: 2px dashed #fb8c00; padding: 15px; min-height: 60px; margin-bottom: 15px; border-radius: 10px; display: flex; gap: 8px; flex-wrap: wrap; background: #fffde7; }
        .drag-source { display: flex; gap: 8px; flex-wrap: wrap; }
        .word-chip { padding: 8px 15px; background: #e0f7fa; border: 1px solid #4dd0e1; border-radius: 20px; cursor: pointer; font-weight: bold; color: #006064; user-select: none; }

        #scoreCard { display: none; text-align: center; background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); max-width: 500px; margin: 20px auto; }
        .score-box { font-size: 60px; color: #fb8c00; font-weight: bold; margin: 20px 0; }
        .total-mark { font-size: 20px; color: #999; }
        .restart-btn { background: #2196f3; color: white; border: none; padding: 10px 25px; border-radius: 20px; cursor: pointer; font-size: 16px; margin-top: 20px; }

        .loading { text-align: center; color: #999; margin-top: 10px; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
    </style>
</head>
<body>

<a href="index.html" class="home-link">ğŸ  è¿”å›å¤§å…</a>

<div class="container">
    <!-- 1. å°é¢ä¸é€‰æ‹©åŒº -->
    <div id="coverPage">
        <div class="hero-icon">ğŸ“</div>
        <h1 class="main-title">ç¬”è¯•æŒ‘æˆ˜</h1>
        
        <div class="welcome-card">
            <div class="selector-group">
                <label class="selector-label">ğŸ—ºï¸ ç¬¬ä¸€æ­¥ï¼šé€‰æ‹©æŒ‘æˆ˜å…³å¡</label>
                <select id="quizSelector" onchange="loadSelectedQuiz()">
                    <option value="" disabled selected>-- è¯·é€‰æ‹©å•å…ƒ --</option>
                    <!-- èœå• JS ç”Ÿæˆ -->
                </select>
            </div>

            <div class="mission-box" id="statusBox" style="display:none;">
                <div id="missionTitle" class="loading">ç­‰å¾…é€‰æ‹©...</div>
            </div>

            <div class="selector-group" style="margin-top: 20px;">
                <label class="selector-label">ğŸ‘‹ ç¬¬äºŒæ­¥ï¼šæ‰¾åˆ°ä½ çš„åå­—</label>
                <select id="studentSelector" onchange="checkStartReady()" disabled>
                    <option value="" disabled selected>-- (è¯·å…ˆé€‰æ‹©å…³å¡) --</option>
                </select>
            </div>
        </div>

        <button id="startButton" disabled onclick="startQuiz()">ğŸš€ å‡†å¤‡å¥½äº†ï¼Œå¼€å§‹ï¼</button>
    </div>

    <!-- 2. è€ƒè¯•è¿›è¡Œä¸­ -->
    <div id="fixedHeader">
        <div class="header-left">
            <span class="student-badge">ğŸ‘¤ <span id="studentDisplay">åŒå­¦</span></span>
        </div>
        <div class="header-right">
            â³ <span id="timerDisplay">09:00</span>
        </div>
    </div>

    <div id="quizContainer"></div>

    <!-- 3. ç»“æœé¡µ -->
    <div id="scoreCard">
        <div class="hero-icon">ğŸ‰</div>
        <h2>æŒ‘æˆ˜å®Œæˆï¼</h2>
        <div class="score-box">
            <div id="finalScore">?</div>
            <div class="total-mark">/ æ€»åˆ†</div>
        </div>
        <div id="timeTakenDisplay" style="color:#888;"></div>
        <p id="gradeFeedback">è¯„ä»·ç”Ÿæˆä¸­...</p>
        <button class="restart-btn" onclick="resetForNextStudent()">ä¸‹ä¸€ä½åŒå­¦</button>
    </div>
</div>

<div id="loadingOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:2000; justify-content:center; align-items:center; flex-direction:column;">
    <div style="font-size:40px;">ğŸ”„</div>
    <p>æ­£åœ¨æäº¤è¯•å·...</p>
</div>

<script>
    // ============================================================
    // ğŸ›ï¸ 1. å…¨å±€é…ç½®åŒº
    // ============================================================
    
    // ğŸ“‹ ç¬”è¯•èœå• (å®Œæ•´é¢„è®¾ U1-U4)
    const WRITTEN_MENU = [
        // --- Unit 1 ---
        { label: "Unit 1 Lesson 1: Nice to meet you", path: "data/written/u1_l1.js" },
        { label: "Unit 1 Lesson 2: What's your name?", path: "data/written/u1_l2.js" },
        { label: "Unit 1 Lesson 3: How are you?", path: "data/written/u1_l3.js" },
        { label: "Unit 1 Lesson 4: Have a good day!", path: "data/written/u1_l4.js" },
        
        // --- Unit 2 ---
        { label: "Unit 2 Lesson 1: Let's play!", path: "data/written/u2_l1.js" },
        { label: "Unit 2 Lesson 2: How many ducks?", path: "data/written/u2_l2.js" },
        { label: "Unit 2 Lesson 3: How old are you?", path: "data/written/u2_l3.js" },
        { label: "Unit 2 Lesson 4: Phone number", path: "data/written/u2_l4.js" },
        
        // --- Unit 3 ---
        { label: "Unit 3 Lesson 1: It's green", path: "data/written/u3_l1.js" },
        { label: "Unit 3 Lesson 2: What color is it?", path: "data/written/u3_l2.js" },
        { label: "Unit 3 Lesson 3: Show me red", path: "data/written/u3_l3.js" },
        { label: "Unit 3 Lesson 4: Colorful flowers", path: "data/written/u3_l4.js" },

        // --- Unit 4 ---
        { label: "Unit 4 Lesson 1: My father", path: "data/written/u4_l1.js" },
        { label: "Unit 4 Lesson 2: Who is he?", path: "data/written/u4_l2.js" },
        { label: "Unit 4 Lesson 3: Who are they?", path: "data/written/u4_l3.js" },
        { label: "Unit 4 Lesson 4: I love my family", path: "data/written/u4_l4.js" },
    ];

    // ğŸ“‹ å­¦ç”Ÿåå• (å…¨æ ¡ç»Ÿä¸€)
    const STUDENT_LIST = [
        "1. å¼ å®‡è±ª", "2. å¼ ä½³å¯’", "3. å¼ ç¿æ¸Š", "4. å¼ ç¾½éŸ¬", "5. å¼ ç¾èŒ¹",
        "6. å¼ å˜‰é’¦", "7. å¢æ¢¦å©·", "8. å¼ æ‚¦è±", "9. å¼ è¯­æ¶µ", "10. å¼ è‹±è±ª",
        "11. å¼ å¿—é¹", "12. å¼ æ™ºæ°", "13. å¼ æ¢“å©·", "14. å¼ å“çª", "15. å¼ è¯ºä¾",
        "16. å¼ é›¨æ³½", "17. å¼ ä¾å½¤", "18. å¼ è‰ºæ¥ ", "19. å¼ æ€å½¤", "20. å¼ å­è±ª",
        "21. å¼ æ¢“äº¦", "22. å¼ çš“é‘«", "23. å¼ é›¨æ¬£", "24. å¼ å¦‚æ¬£", "25. å¼ æŸæ¶µ",
        "26. å¼ æ¢“çº¯", "27. å¼ æ³½é‘«"
    ];

    // ğŸ“‹ Google Script URL
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxc8c4prsZZLY9vp-te4gH5twQNO1A8Ek3yROTNZeNs-7YhL60UojvMsQoceJUZ7LUP/exec";

    // ============================================================
    // âš™ï¸ 2. æ ¸å¿ƒé€»è¾‘
    // ============================================================
    
    let currentQuizData = null; 
    let currentAnswers = {};
    let timerInterval;
    let timeLeft = 540;
    let quizStartTime = null;

    // åˆå§‹åŒ–ï¼šç”Ÿæˆèœå•
    window.onload = function() {
        const selector = document.getElementById('quizSelector');
        WRITTEN_MENU.forEach(item => {
            const opt = document.createElement('option');
            opt.value = item.path;
            opt.innerText = item.label;
            selector.appendChild(opt);
        });
    };

    // --- åŠ è½½è¯•å· ---
    function loadSelectedQuiz() {
        const filePath = document.getElementById('quizSelector').value;
        if (!filePath) return;

        document.getElementById('statusBox').style.display = 'block';
        document.getElementById('missionTitle').innerText = "â³ æ­£åœ¨è¯»å–é¢˜ç›®...";
        document.getElementById('missionTitle').style.color = "#999";

        // ç§»é™¤æ—§è„šæœ¬
        const oldScript = document.getElementById('dynamic-quiz-script');
        if (oldScript) oldScript.remove();

        const script = document.createElement('script');
        script.id = 'dynamic-quiz-script';
        script.src = filePath;
        
        script.onload = () => {
            console.log("Loaded: " + filePath);
            // ğŸš¨ å…³é”®ï¼šç¡®ä¿æ•°æ®å·²åŠ è½½
            if (!currentQuizData) {
                document.getElementById('missionTitle').innerText = "âŒ æ•°æ®æœªåŠ è½½ (è¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼)";
                document.getElementById('missionTitle').style.color = "red";
                return;
            }
            
            document.getElementById('missionTitle').innerText = "âœ… " + currentQuizData.title;
            document.getElementById('missionTitle').style.color = "#333";
            populateStudents(); 
            document.getElementById('studentSelector').disabled = false;
        };
        
        script.onerror = () => {
            document.getElementById('missionTitle').innerText = "âŒ æš‚æ— æ­¤è¯¾è¯•å·";
            document.getElementById('missionTitle').style.color = "red";
            alert("è€å¸ˆè¿˜æ²¡ä¸Šä¼ è¿™èŠ‚è¯¾çš„é¢˜ç›®å“¦ï¼\n(æ–‡ä»¶æœªæ‰¾åˆ°: " + filePath + ")");
        };
        
        document.body.appendChild(script);
    }

    // --- æ¥æ”¶æ•°æ® (window.LOAD_QUIZ) ---
    window.LOAD_QUIZ = function(data) {
        console.log("æ•°æ®æ¥æ”¶æˆåŠŸ:", data);
        currentQuizData = data; 
        if (data.timeLimit) timeLeft = data.timeLimit;
    };

    // --- å¡«å……å­¦ç”Ÿåå• ---
    function populateStudents() {
        const selector = document.getElementById('studentSelector');
        selector.innerHTML = '<option value="" disabled selected>-- ç‚¹è¿™é‡Œé€‰æ‹©å§“å --</option>';
        STUDENT_LIST.forEach(name => {
            const opt = document.createElement('option');
            opt.value = name;
            opt.innerText = name;
            selector.appendChild(opt);
        });
    }

    function checkStartReady() {
        if (document.getElementById('studentSelector').value) {
            document.getElementById('startButton').disabled = false;
        }
    }

    // --- å¼€å§‹è€ƒè¯• ---
    function startQuiz() {
        if (!currentQuizData || !currentQuizData.questions || currentQuizData.questions.length === 0) {
            alert("âŒ é”™è¯¯ï¼šè¯•å·æ•°æ®ä¸ºç©ºï¼");
            return;
        }

        document.getElementById('coverPage').style.display = 'none';
        document.getElementById('quizContainer').style.display = 'block';
        document.getElementById('fixedHeader').style.display = 'flex';
        document.getElementById('studentDisplay').textContent = document.getElementById('studentSelector').value;
        
        // æ¸²æŸ“é¢˜ç›®
        renderQuestions();
        startTimer();
    }

    // --- æ¸²æŸ“é¢˜ç›® ---
    function renderQuestions() {
        const container = document.getElementById('quizContainer');
        container.innerHTML = '';

        currentQuizData.questions.forEach((q, idx) => {
            const qDiv = document.createElement('div');
            qDiv.className = 'question-page';
            
            // é¢˜å¹²
            let html = `<div style="color:#fb8c00;font-size:12px;font-weight:bold;margin-bottom:5px;">Q${q.qNum} (${q.part || 'Part'})</div>`;
            html += `<div style="font-size:18px;font-weight:bold;margin-bottom:15px;color:#333;">${q.text}</div>`;

            // å›¾ç‰‡å¤„ç†
            let imgSrc = q.imageUri;
            if (q.imageKey && currentQuizData.images) { 
                imgSrc = currentQuizData.images[q.imageKey];
            }
            if (imgSrc) {
                // è‡ªåŠ¨è¡¥å…¨ img/ å‰ç¼€
                if (!imgSrc.startsWith('http') && !imgSrc.startsWith('img/')) imgSrc = 'img/' + imgSrc;
                html += `<div style="text-align:center;margin:10px 0;"><img src="${imgSrc}" style="max-width:100%;max-height:200px;border-radius:8px;" onerror="this.style.display='none'"></div>`;
            }

            // å¬åŠ›
            if (q.audioText) {
                const safeText = q.audioText.replace(/'/g, "\\'");
                html += `<div style="text-align:center;margin-bottom:15px;"><button onclick="speakText('${safeText}')" style="background:#e1f5fe;color:#0288d1;border:none;padding:8px 15px;border-radius:20px;font-weight:bold;cursor:pointer;">ğŸ”Š æ’­æ”¾å½•éŸ³</button></div>`;
            }

            // é€‰é¡¹
            if (q.type === 'select') {
                html += `<div style="display:grid;gap:10px;">`;
                q.options.forEach(opt => {
                    let display = opt;
                    let val = opt;
                    // å›¾ç‰‡é€‰é¡¹å¤„ç†
                    if (opt.startsWith('image:')) {
                        const key = opt.split(':')[1];
                        let src = currentQuizData.images[key];
                        if (src && !src.startsWith('http') && !src.startsWith('img/')) src = 'img/' + src;
                        display = `<img src="${src}" style="height:60px;vertical-align:middle">`;
                        val = 'image:'+key; 
                    } else if (opt.includes('/') && (opt.endsWith('.png') || opt.endsWith('.jpg'))) {
                        display = `<img src="${opt}" style="height:60px;vertical-align:middle">`;
                    }

                    const safeVal = val.replace(/'/g, "\\'");
                    // IDå¿…é¡»å”¯ä¸€
                    const btnId = `opt-${q.qNum}-${safeVal.replace(/[^a-zA-Z0-9]/g, '')}`;
                    
                    html += `<div class="answer-option" id="${btnId}" 
                             onclick="selectOption(${q.qNum}, '${safeVal}', this)">
                                ${display}
                             </div>`;
                });
                html += `</div>`;
            } 
            else if (q.type === 'drag-sort') {
                html += `<div class="drag-target" id="target-${q.qNum}"></div>`;
                html += `<div class="drag-source" id="source-${q.qNum}">`;
                q.words.forEach(word => {
                    html += `<div class="word-chip" onclick="moveWord(this, 'source-${q.qNum}', 'target-${q.qNum}', ${q.qNum})">${word}</div>`;
                });
                html += `</div>`;
            }

            qDiv.innerHTML = html;
            container.appendChild(qDiv);
        });

        // äº¤å·æŒ‰é’®
        const btn = document.createElement('button');
        btn.innerText = "äº¤å· (Submit)";
        btn.style = "display:block;width:100%;padding:15px;background:#4caf50;color:white;font-size:18px;font-weight:bold;border:none;border-radius:12px;margin-top:30px;cursor:pointer;";
        btn.onclick = submitAnswers;
        container.appendChild(btn);
    }

    // --- äº¤äº’é€»è¾‘ ---
    function selectOption(qNum, val, el) {
        currentAnswers[`Q${qNum}`] = val;
        const parent = el.parentElement;
        Array.from(parent.children).forEach(child => child.classList.remove('selected-option'));
        el.classList.add('selected-option');
    }

    function moveWord(el, sid, tid, qNum) {
        const source = document.getElementById(sid);
        const target = document.getElementById(tid);
        
        if (el.parentElement.id === sourceId) target.appendChild(el);
        else source.appendChild(el);
        
        const words = Array.from(target.children).map(c => c.innerText).join(' ');
        currentAnswers[`Q${qNum}`] = words;
    }

    function startTimer() {
        clearInterval(timerInterval);
        const display = document.getElementById('timerDisplay');
        timerInterval = setInterval(() => {
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                display.innerText = "00:00";
                submitAnswers();
                return;
            }
            timeLeft--;
            const m = Math.floor(timeLeft / 60).toString().padStart(2,'0');
            const s = (timeLeft % 60).toString().padStart(2,'0');
            display.innerText = `${m}:${s}`;
        }, 1000);
    }

    function submitAnswers() {
        clearInterval(timerInterval);
        document.getElementById('loadingOverlay').style.display = 'flex';
        
        let score = 0;
        const totalQ = currentQuizData.questions.length;
        
        // åˆ¤åˆ†é€»è¾‘
        currentQuizData.questions.forEach((q, idx) => {
            const userAns = currentAnswers[`Q${q.qNum}`];
            let isCorrect = false;
            
            if (userAns === q.correct) isCorrect = true;
            else if (q.type === 'drag-sort') {
                if (userAns && userAns.replace(/[.,?!]/g, '').trim() === q.correct.replace(/[.,?!]/g, '').trim()) isCorrect = true;
            }

            if (isCorrect) score += 5;
            
            // ç«‹å³æ˜¾ç¤ºåé¦ˆ
            const card = document.getElementsByClassName('question-page')[idx];
            if (card) {
                const fbDiv = document.createElement('div');
                fbDiv.style.marginTop = '10px';
                fbDiv.style.padding = '10px';
                fbDiv.style.borderRadius = '5px';
                if (isCorrect) {
                    fbDiv.style.background = '#e8f5e9';
                    fbDiv.style.color = '#2e7d32';
                    fbDiv.innerText = "âœ… æ­£ç¡® (+5)";
                } else {
                    fbDiv.style.background = '#ffebee';
                    fbDiv.style.color = '#c62828';
                    let showCorrect = q.correct.replace('image:', '');
                    fbDiv.innerHTML = `âŒ é”™è¯¯ <br><small>æ­£ç¡®ç­”æ¡ˆ: ${showCorrect}</small>`;
                }
                card.appendChild(fbDiv);
            }
        });

        // ä¸Šä¼  Google Sheet
        const studentName = document.getElementById('studentSelector').value;
        const payload = {
            studentName: studentName,
            examType: "Written",
            lessonTitle: currentQuizData.title,
            score: score,
            duration: `${Math.floor((currentQuizData.timeLimit - timeLeft)/60)}m`,
            details: JSON.stringify(currentAnswers)
        };

        fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        }).then(() => {
            console.log("Uploaded");
        });

        // åˆ‡æ¢åˆ°ç»“æœé¡µ
        setTimeout(() => {
            document.getElementById('loadingOverlay').style.display = 'none';
            document.getElementById('quizContainer').style.display = 'none'; 
            document.getElementById('fixedHeader').style.display = 'none';
            document.getElementById('scoreCard').style.display = 'block';
            
            document.querySelector('.total-mark').innerText = `/ ${totalQ * 5} åˆ†`;
            document.getElementById('finalScore').innerText = score;
            
            let feedback = "åŠ æ²¹ï¼";
            if (score >= totalQ * 5 * 0.9) feedback = "å¤ªæ£’äº†ï¼ğŸ‰";
            else if (score >= totalQ * 5 * 0.6) feedback = "åŠæ ¼å•¦ï¼ğŸ‘";
            else feedback = "è¦å†åŠªåŠ›å“¦ï¼ğŸ’ª";
            document.getElementById('gradeFeedback').innerText = feedback;
        }, 1000);
    }

    function resetForNextStudent() { location.reload(); }

    function speakText(text) {
        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = "en-US"; u.rate = 0.8;
            window.speechSynthesis.speak(u);
        } else { alert("ä¸æ”¯æŒæœ—è¯»"); }
    }
</script>

</body>
</html>
