<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸‰å¹´çº§è‹±è¯­é—¯å…³èµ› (V6.0 Final)</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* ==================== V6.0 æ ¸å¿ƒæ ·å¼ ==================== */
        body { font-family: 'Comic Sans MS', 'Chalkboard SE', sans-serif; background-color: #f0f4f8; margin: 0; padding: 20px; color: #333; }
        
        /* å¸ƒå±€å®¹å™¨ */
        .container { max-width: 900px; margin: 0 auto; }
        .hidden { display: none !important; }

        /* é¦–é¡µåŒå¡ç‰‡å¸ƒå±€ (å·¦å³åˆ†æ ) */
        .home-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 40px; }
        @media (max-width: 700px) { .home-grid { grid-template-columns: 1fr; } }

        .mode-card { background: white; border-radius: 20px; padding: 30px; text-align: center; box-shadow: 0 8px 20px rgba(0,0,0,0.05); transition: transform 0.2s; border: 4px solid transparent; }
        .mode-card:hover { transform: translateY(-5px); }
        
        /* å£è¯­å¡ç‰‡é£æ ¼ (è“è‰²-è€å¸ˆ) */
        .card-oral { border-color: #42a5f5; }
        .card-oral h2 { color: #1976d2; }
        .btn-oral { background: #1976d2; color: white; }

        /* ç¬”è¯•å¡ç‰‡é£æ ¼ (æ©™è‰²-å­¦ç”Ÿ) */
        .card-written { border-color: #fb8c00; }
        .card-written h2 { color: #e65100; }
        .btn-written { background: #ef6c00; color: white; }

        /* é€šç”¨æ§ä»¶ */
        select { width: 100%; padding: 12px; font-size: 16px; border: 2px solid #ddd; border-radius: 10px; margin: 15px 0; background: #fafafa; }
        button { border: none; padding: 12px 30px; border-radius: 25px; font-size: 16px; font-weight: bold; cursor: pointer; width: 100%; transition: opacity 0.2s; }
        button:disabled { background: #ccc !important; cursor: not-allowed; }
        button:active { transform: scale(0.98); }

        /* å€™è€ƒå®¤ & é¡¶éƒ¨æ  */
        .waiting-room { background: white; padding: 40px; border-radius: 20px; text-align: center; max-width: 500px; margin: 50px auto; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .fixed-header { position: sticky; top: 0; background: rgba(255,255,255,0.95); z-index: 100; padding: 10px 20px; display: flex; justify-content: space-between; border-radius: 0 0 15px 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        /* é¢˜ç›®å¡ç‰‡ */
        .question-card { background: white; border-radius: 16px; padding: 20px; margin-bottom: 20px; border-left: 6px solid #ccc; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .q-tag { font-size: 12px; font-weight: bold; margin-bottom: 5px; color: #888; }
        .q-text { font-size: 20px; font-weight: bold; margin-bottom: 15px; color: #333; }
        .q-img { max-width: 100%; height: auto; max-height: 200px; border-radius: 10px; display: block; margin: 10px auto; }

        /* ç¬”è¯•äº¤äº’ */
        .option-btn { display: block; width: 100%; padding: 12px; margin: 8px 0; border: 2px solid #eee; border-radius: 10px; background: white; text-align: left; cursor: pointer; }
        .option-btn.selected { border-color: #fb8c00; background: #fff3e0; }
        
        /* å£è¯­æ‰“åˆ†äº¤äº’ */
        .teacher-guide { background: #e3f2fd; padding: 10px; border-radius: 8px; color: #0d47a1; font-size: 14px; margin-bottom: 10px; text-align: left; }
        .emoji-bar { display: flex; justify-content: space-around; font-size: 24px; margin-top: 10px; }
        .emoji-btn { cursor: pointer; opacity: 0.5; transition: 0.2s; background: none; border: none; font-size: 28px; }
        .emoji-btn:hover { opacity: 1; transform: scale(1.2); }
        .emoji-btn.active { opacity: 1; transform: scale(1.3); text-shadow: 0 0 10px gold; }

        /* æ‹–æ‹½é¢˜æ ·å¼ */
        .drag-area { min-height: 50px; border: 2px dashed #ccc; padding: 10px; border-radius: 10px; background: #fafafa; display: flex; flex-wrap: wrap; gap: 5px; }
        .word-chip { background: #e0f7fa; padding: 5px 12px; border-radius: 15px; border: 1px solid #4dd0e1; cursor: pointer; font-weight: bold; color: #006064; }
    </style>
</head>
<body>

<div class="container">

    <div id="homePage">
        <h1 style="text-align:center; color:#546e7a; margin-bottom:5px;">ğŸ¦ è‹±è¯­é—¯å…³èµ› (Grade 3)</h1>
        <p style="text-align:center; color:#90a4ae; margin-top:0;">è¯·é€‰æ‹©ä¸€ç§æŒ‘æˆ˜æ¨¡å¼</p>

        <div class="home-grid">
            <div class="mode-card card-oral">
                <div style="font-size:50px;">ğŸ—£ï¸</div>
                <h2>å£è¯­é¢è¯•</h2>
                <p style="color:#666; font-size:14px;">Teacher Mode: è€å¸ˆæé—®å¹¶æ‰“åˆ†</p>
                
                <label style="display:block; text-align:left; font-weight:bold; color:#1976d2;">é€‰æ‹©è¯¾ç¨‹ (U1-U4)ï¼š</label>
                <select id="oralMenu">
                    <option value="" disabled selected>-- è¯·é€‰æ‹©å£è¯­é¢˜åº“ --</option>
                </select>
                <button class="btn-oral" onclick="selectMode('speaking')">è¿›å…¥é¢è¯•è€ƒåœº âœ</button>
            </div>

            <div class="mode-card card-written">
                <div style="font-size:50px;">ğŸ“</div>
                <h2>ç¬”è¯•æŒ‘æˆ˜</h2>
                <p style="color:#666; font-size:14px;">Student Mode: å­¦ç”Ÿè‡ªæµ‹ä¸é—¯å…³</p>
                
                <label style="display:block; text-align:left; font-weight:bold; color:#e65100;">é€‰æ‹©è¯¾ç¨‹ (U1-U4)ï¼š</label>
                <select id="writtenMenu">
                    <option value="" disabled selected>-- è¯·é€‰æ‹©ç¬”è¯•é¢˜åº“ --</option>
                </select>
                <button class="btn-written" onclick="selectMode('written')">è¿›å…¥ç¬”è¯•æŒ‘æˆ˜ âœ</button>
            </div>
        </div>
    </div>

    <div id="waitingRoom" class="waiting-room hidden">
        <div style="font-size:40px; margin-bottom:10px;">ğŸ“</div>
        <h2 id="roomTitle">å‡†å¤‡å¼€å§‹</h2>
        <p id="roomSubtitle" style="color:#888;">æ­£åœ¨åŠ è½½è¯•å·...</p>
        
        <div style="text-align:left; margin: 20px 0;">
            <label>è¯·é€‰æ‹©å­¦ç”Ÿå§“åï¼š</label>
            <select id="studentSelector" onchange="enableStart()" disabled>
                <option value="" disabled selected>-- åŠ è½½ä¸­ --</option>
            </select>
        </div>

        <button id="startBtn" onclick="startQuiz()" disabled style="background:#4caf50; color:white;">ğŸš€ å¼€å§‹ (Start)</button>
    </div>

    <div id="quizInterface" class="hidden">
        <div class="fixed-header">
            <div>ğŸ‘¤ <span id="currentStudent">åŒå­¦</span></div>
            <div id="timerDisplay" style="font-family:monospace; font-weight:bold; color:#e65100; font-size:18px;">00:00</div>
        </div>

        <div id="questionsList">
            </div>

        <button id="submitBtn" onclick="submitPaper()" style="margin-top:20px; background:#4caf50; color:white; padding:15px;">âœ… äº¤å· (Submit)</button>
    </div>

    <div id="scoreCard" class="waiting-room hidden">
        <div style="font-size:60px;">ğŸ‰</div>
        <h2 style="color:#fb8c00;">è€ƒè¯•ç»“æŸ!</h2>
        <div style="font-size:50px; font-weight:bold; color:#333; margin:20px 0;">
            <span id="finalScore">?</span> <span style="font-size:20px; color:#999;">åˆ†</span>
        </div>
        <button onclick="goHome()" style="background:#2196f3; color:white;">ğŸ  è¿”å›å¤§å…</button>
    </div>

</div>

<div id="loadingOverlay" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:2000; display:flex; justify-content:center; align-items:center; flex-direction:column;">
    <div style="font-size:40px; animation:bounce 1s infinite;">ğŸ”„</div>
    <p>æ­£åœ¨ä¸Šä¼ æˆç»©...</p>
</div>

<script>
    // ================= é…ç½®æ•°æ®åŒº (å·²æ•´åˆ U1-U4) =================

    // ğŸ—£ï¸ å£è¯­èœå• (è·¯å¾„æŒ‡å‘ data/speaking/)
    const ORAL_MENU = [
        // --- Unit 1 ---
        { label: "Unit 1 Lesson 1: Nice to meet you", path: "data/speaking/u1_l1.js" },
        { label: "Unit 1 Lesson 2: What's your name?", path: "data/speaking/u1_l2.js" },
        { label: "Unit 1 Lesson 3: How are you?", path: "data/speaking/u1_l3.js" },
        { label: "Unit 1 Lesson 4: Have a good day!", path: "data/speaking/u1_l4.js" },
        
        // --- Unit 2 ---
        { label: "Unit 2 Lesson 1: Let's play!", path: "data/speaking/u2_l1.js" },
        { label: "Unit 2 Lesson 2: How many ducks?", path: "data/speaking/u2_l2.js" },
        { label: "Unit 2 Lesson 3: How old are you?", path: "data/speaking/u2_l3.js" },
        { label: "Unit 2 Lesson 4: Phone number", path: "data/speaking/u2_l4.js" },
        
        // --- Unit 3 ---
        { label: "Unit 3 Lesson 1: It's green", path: "data/speaking/u3_l1.js" },
        { label: "Unit 3 Lesson 2: What color is it?", path: "data/speaking/u3_l2.js" },
        { label: "Unit 3 Lesson 3: Show me red", path: "data/speaking/u3_l3.js" },
        { label: "Unit 3 Lesson 4: Colorful flowers", path: "data/speaking/u3_l4.js" },

        // --- Unit 4 ---
        { label: "Unit 4 Lesson 1: My father", path: "data/speaking/u4_l1.js" },
        { label: "Unit 4 Lesson 2: Who is he?", path: "data/speaking/u4_l2.js" },
        { label: "Unit 4 Lesson 3: Who are they?", path: "data/speaking/u4_l3.js" },
        { label: "Unit 4 Lesson 4: I love my family", path: "data/speaking/u4_l4.js" },
    ];

    // ğŸ“ ç¬”è¯•èœå• (è·¯å¾„æŒ‡å‘ data/written/)
    const WRITTEN_MENU = [
        // --- Unit 1 ---
        { label: "Unit 1 Lesson 1: Nice to meet you", path: "data/written/u1_l1.js" },
        { label: "Unit 1 Lesson 2: What's your name?", path: "data/written/u1_l2.js" },
        { label: "Unit 1 Lesson 3: How are you?", path: "data/written/u1_l3.js" },
        { label: "Unit 1 Lesson 4: Have a good day!", path: "data/written/u1_l4.js" },
        
        // --- Unit 2 ---
        { label: "Unit 2 Lesson 1: Let's play!", path: "data/written/u2_l1.js" },
        { label: "Unit 2 Lesson 2: How many ducks?", path: "data/written/u2_l2.js" },
        { label: "Unit 2 Lesson 3: How old are you?", path: "data/written/u2_l3.js" },
        { label: "Unit 2 Lesson 4: Phone number", path: "data/written/u2_l4.js" },
        
        // --- Unit 3 ---
        { label: "Unit 3 Lesson 1: It's green", path: "data/written/u3_l1.js" },
        { label: "Unit 3 Lesson 2: What color is it?", path: "data/written/u3_l2.js" },
        { label: "Unit 3 Lesson 3: Show me red", path: "data/written/u3_l3.js" },
        { label: "Unit 3 Lesson 4: Colorful flowers", path: "data/written/u3_l4.js" },

        // --- Unit 4 ---
        { label: "Unit 4 Lesson 1: My father", path: "data/written/u4_l1.js" },
        { label: "Unit 4 Lesson 2: Who is he?", path: "data/written/u4_l2.js" },
        { label: "Unit 4 Lesson 3: Who are they?", path: "data/written/u4_l3.js" },
        { label: "Unit 4 Lesson 4: I love my family", path: "data/written/u4_l4.js" },
    ];

    const STUDENTS = [
        "1. å¼ å®‡è±ª", "2. å¼ ä½³å¯’", "3. å¼ ç¿æ¸Š", "4. å¼ ç¾½éŸ¬", "5. å¼ ç¾èŒ¹",
        "6. å¼ å˜‰é’¦", "7. å¢æ¢¦å©·", "8. å¼ æ‚¦è±", "9. å¼ è¯­æ¶µ", "10. å¼ è‹±è±ª",
        "11. å¼ å¿—é¹", "12. å¼ æ™ºæ°", "13. å¼ æ¢“å©·", "14. å¼ å“çª", "15. å¼ è¯ºä¾",
        "16. å¼ é›¨æ³½", "17. å¼ ä¾å½¤", "18. å¼ è‰ºæ¥ ", "19. å¼ æ€å½¤", "20. å¼ å­è±ª",
        "21. å¼ æ¢“äº¦", "22. å¼ çš“é‘«", "23. å¼ é›¨æ¬£", "24. å¼ å¦‚æ¬£", "25. å¼ æŸæ¶µ",
        "26. å¼ æ¢“çº¯", "27. å¼ æ³½é‘«"
    ];

    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxc8c4prsZZLY9vp-te4gH5twQNO1A8Ek3yROTNZeNs-7YhL60UojvMsQoceJUZ7LUP/exec";

    // ================= æ ¸å¿ƒé€»è¾‘åŒº =================
    let currentMode = ''; // 'speaking' | 'written'
    let currentData = null;
    let answers = {};
    let timerInterval;
    let timeLeft = 0;

    // 1. åˆå§‹åŒ–ï¼šå¡«å……ä¸¤ä¸ªèœå•
    window.onload = function() {
        fillMenu('oralMenu', ORAL_MENU);
        fillMenu('writtenMenu', WRITTEN_MENU);
        fillStudentList();
    };

    function fillMenu(id, list) {
        const sel = document.getElementById(id);
        list.forEach(item => {
            const opt = document.createElement('option');
            opt.value = item.path;
            opt.innerText = item.label;
            sel.appendChild(opt);
        });
    }

    // 2. é¦–é¡µï¼šé€‰æ‹©æ¨¡å¼å¹¶åŠ è½½æ•°æ®
    function selectMode(mode) {
        const menuId = mode === 'speaking' ? 'oralMenu' : 'writtenMenu';
        const path = document.getElementById(menuId).value;

        if (!path) { alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè¯¾ç¨‹ï¼"); return; }

        currentMode = mode;
        loadScript(path);
    }

    // 3. åŠ¨æ€åŠ è½½ JS é¢˜åº“
    function loadScript(path) {
        document.getElementById('homePage').classList.add('hidden');
        document.getElementById('waitingRoom').classList.remove('hidden');
        // (å·²åˆ é™¤è¿”å›æŒ‰é’®æ˜¾ç¤ºé€»è¾‘)
        
        // æ¸…ç†æ—§æ•°æ®
        currentData = null;
        answers = {};
        const old = document.getElementById('dynamic-quiz');
        if (old) old.remove();

        const script = document.createElement('script');
        script.id = 'dynamic-quiz';
        script.src = path;
        script.onload = () => {
            if (currentData) {
                document.getElementById('roomTitle').innerText = (currentMode === 'speaking' ? "ğŸ—£ï¸ " : "ğŸ“ ") + currentData.title;
                document.getElementById('roomSubtitle').innerText = "æ•°æ®åŠ è½½æˆåŠŸï¼Œè¯·é€‰æ‹©å­¦ç”Ÿ";
                document.getElementById('studentSelector').disabled = false;
            } else {
                alert("æ•°æ®æ–‡ä»¶æ ¼å¼é”™è¯¯ (æœªæ‰¾åˆ° window.LOAD_QUIZ)");
                goHome();
            }
        };
        script.onerror = () => {
            alert("âŒ é¢˜åº“æ–‡ä»¶æœªæ‰¾åˆ° (404)\nè¯·æ£€æŸ¥è·¯å¾„: " + path);
            goHome();
        };
        document.body.appendChild(script);
    }

    // æ¥å£ï¼šé¢˜åº“ JS è°ƒç”¨æ­¤å‡½æ•°
    window.LOAD_QUIZ = function(data) {
        currentData = data;
        timeLeft = data.timeLimit || (currentMode === 'speaking' ? 300 : 540); // å£è¯­é»˜è®¤5åˆ†é’Ÿï¼Œç¬”è¯•9åˆ†é’Ÿ
    };

    function fillStudentList() {
        const sel = document.getElementById('studentSelector');
        STUDENTS.forEach(name => {
            const opt = document.createElement('option');
            opt.value = name;
            opt.innerText = name;
            sel.appendChild(opt);
        });
    }

    function enableStart() {
        document.getElementById('startBtn').disabled = false;
    }

    // 4. å¼€å§‹è€ƒè¯•
    function startQuiz() {
        document.getElementById('waitingRoom').classList.add('hidden');
        document.getElementById('quizInterface').classList.remove('hidden');
        document.getElementById('currentStudent').innerText = document.getElementById('studentSelector').value;

        renderQuestions();
        startTimer();
    }

    // 5. æ¸²æŸ“é¢˜ç›® (æ ¸å¿ƒå·®å¼‚é€»è¾‘)
    function renderQuestions() {
        const container = document.getElementById('questionsList');
        container.innerHTML = '';

        currentData.questions.forEach((q, index) => {
            const card = document.createElement('div');
            card.className = 'question-card';
            if(currentMode === 'speaking') card.style.borderLeftColor = '#42a5f5';
            else card.style.borderLeftColor = '#fb8c00';

            // é¢˜å¹²
            let html = `<div class="q-tag">Question ${q.qNum}</div>`;
            html += `<div class="q-text">${q.text}</div>`;

            // å›¾ç‰‡
            let imgSrc = q.imageUri;
            if (q.imageKey && currentData.images) imgSrc = currentData.images[q.imageKey];
            if (imgSrc) {
                if (!imgSrc.startsWith('http') && !imgSrc.startsWith('img/')) imgSrc = 'img/' + imgSrc;
                html += `<img src="${imgSrc}" class="q-img">`;
            }

            // --- åˆ†æµæ¸²æŸ“ ---
            if (currentMode === 'speaking') {
                // å£è¯­æ¨¡å¼ï¼šæ˜¾ç¤ºå‚è€ƒç­”æ¡ˆ + æ‰“åˆ†æŒ‰é’®
                html += `<div class="teacher-guide">ğŸ’¡ å‚è€ƒç­”æ¡ˆ: ${q.guide || q.correct || 'æ— '}</div>`;
                html += `<div style="text-align:center; margin-top:10px; color:#666; font-size:12px;">è€å¸ˆè¯·æ‰“åˆ†:</div>`;
                html += `<div class="emoji-bar" id="score-bar-${q.qNum}">`;
                ['ğŸ˜¶','ğŸ™‚','ğŸ¤”','ğŸ˜ƒ','ğŸ¤©'].forEach((emoji, i) => {
                    const score = i + 1;
                    html += `<button class="emoji-btn" onclick="rateStudent(${q.qNum}, ${score}, this)">${emoji}</button>`;
                });
                html += `</div>`;
            } else {
                // ç¬”è¯•æ¨¡å¼ï¼šæ˜¾ç¤ºé€‰é¡¹ æˆ– æ‹–æ‹½
                if (q.type === 'select') {
                    q.options.forEach(opt => {
                        let val = opt;
                        let disp = opt;
                        html += `<button class="option-btn" onclick="selectOption(${q.qNum}, '${val}', this)">${disp}</button>`;
                    });
                } else if (q.type === 'drag-sort') {
                    html += `<div class="drag-area" id="target-${q.qNum}"></div>`;
                    html += `<div class="drag-area" id="source-${q.qNum}" style="margin-top:10px; border:none;">`;
                    q.words.forEach(w => {
                        html += `<span class="word-chip" onclick="moveWord(this, 'target-${q.qNum}', 'source-${q.qNum}', ${q.qNum})">${w}</span>`;
                    });
                    html += `</div>`;
                }
            }
            
            card.innerHTML = html;
            container.appendChild(card);
        });
    }

    // --- äº¤äº’é€»è¾‘ (ç¬”è¯•) ---
    function selectOption(qNum, val, btn) {
        answers['Q'+qNum] = val;
        const parent = btn.parentElement;
        Array.from(parent.children).forEach(c => {
            if(c.classList.contains('option-btn')) c.classList.remove('selected');
        });
        btn.classList.add('selected');
    }

    function moveWord(el, targetId, sourceId, qNum) {
        const target = document.getElementById(targetId);
        const source = document.getElementById(sourceId);
        if (el.parentElement.id === sourceId.replace('source','target')) source.appendChild(el); 
        else target.appendChild(el); 
        
        answers['Q'+qNum] = Array.from(target.children).map(c => c.innerText).join(' ');
    }

    // --- äº¤äº’é€»è¾‘ (å£è¯­) ---
    function rateStudent(qNum, score, btn) {
        answers['Q'+qNum] = score; 
        const parent = btn.parentElement;
        Array.from(parent.children).forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
    }

    // 6. è®¡æ—¶ä¸æäº¤
    function startTimer() {
        clearInterval(timerInterval);
        const display = document.getElementById('timerDisplay');
        timerInterval = setInterval(() => {
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                submitPaper();
                return;
            }
            timeLeft--;
            const m = Math.floor(timeLeft/60).toString().padStart(2,'0');
            const s = (timeLeft%60).toString().padStart(2,'0');
            display.innerText = `${m}:${s}`;
        }, 1000);
    }

    function submitPaper() {
        clearInterval(timerInterval);
        document.getElementById('loadingOverlay').classList.remove('hidden');

        // è®¡ç®—æ€»åˆ†
        let totalScore = 0;
        if (currentMode === 'speaking') {
            Object.values(answers).forEach(val => totalScore += parseInt(val || 0));
        } else {
            currentData.questions.forEach(q => {
                const userAns = answers['Q'+q.qNum];
                if (userAns === q.correct) totalScore += 5;
                else if (q.type === 'drag-sort' && userAns && userAns.replace(/[.,?!]/g,'') === q.correct.replace(/[.,?!]/g,'')) totalScore += 5;
            });
        }

        // ä¸Šä¼ 
        const payload = {
            studentName: document.getElementById('studentSelector').value,
            examType: currentMode === 'speaking' ? 'Oral' : 'Written',
            lessonTitle: currentData.title,
            score: totalScore,
            duration: "N/A", 
            details: JSON.stringify(answers)
        };

        console.log("Submitting:", payload);

        fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        }).then(() => {
            setTimeout(() => {
                document.getElementById('loadingOverlay').classList.add('hidden');
                document.getElementById('quizInterface').classList.add('hidden');
                document.getElementById('scoreCard').classList.remove('hidden');
                document.getElementById('finalScore').innerText = totalScore;
            }, 1000);
        });
    }

    function goHome() {
        location.reload();
    }
</script>

</body>
</html>
